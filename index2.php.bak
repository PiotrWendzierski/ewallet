<?php
	session_start();
	if(!isset($_SESSION['zalogowany']))
	{
		header('Location: login.php');
		exit();
	}
	if(!isset($_SESSION['stan_konta'])|| ($_SESSION['stan_konta'] ==false))
	{
		header('Location: index.php');
		exit();
	}
	require_once "connect.php";
?>
<!DOCTYPE HTML>
<html lang="pl">
<head>
	<meta charset="utf-8">
	<title>eWallet - twój elektroniczny portfel</title>
	<link rel="stylesheet"  href="style.css" type="text/css" / >
</head>
<body>
<div id="container">
	<div id="title">
		eWallett
	</div>
	<div id="meni">		
		<div class="option"><a href="index2.php">Ekran główny</a></div>
		<div class="option"><a href="dodawanie.php">Wprowadzanie transakcji</a></div>
		<div class="option"><a href="historia.php">Historia portfela</a></div>
		<div class="option"><a href="skarbonka.php">Skarbonka</a></div>
		<div class="option"><a href="wyloguj.php">Wyloguj</a></div>
		<div style="clear:both;"></div>
	</div>
	<?php
		echo "Witaj ".$_SESSION['user']." w swoim wirtualnym portfelu!</br></br>";
			  try
			{
				$polaczenie = new mysqli($host, $db_user, $db_password, $db_name);
				if($polaczenie->connect_errno!=0)
			  {
					throw new Exception(mysqli_connect_errno());
			    }
				else
				{
					$user = $_SESSION['user'];
					$sql="SELECT 	stan_konta FROM uzytkownicy WHERE login='$user'";
					if($rezultat = $polaczenie->query($sql))
					{
						$wiersz  = $rezultat->fetch_assoc();
						$stan_konta = $wiersz['stan_konta'];
						$_SESSION['stan_konta'] = $stan_konta;
					}
					else 
					{
						throw new Exception($polaczenie->error);
					}
					$id = $_SESSION['id'];
					$sql2 = "SELECT * FROM transakcje WHERE id = '$id'";
					if($rezultat = $polaczenie -> query($sql2))
					{
						$ile_transakcji = $rezultat->num_rows;
						if ($ile_transakcji > 0)
						{
							$sql3 = "SELECT * FROM transakcje WHERE id = '$id' ORDER BY data DESC LIMIT 1 ";
							if ($rezultat = $polaczenie -> query ($sql3))
							{
								$wiersz2 = $rezultat -> fetch_assoc();
								$kategoria = $wiersz2['kategoria'];
								$data = $wiersz2['data'];
								$cena = $wiersz2['cena'];
							}
						}
					}
					else 
					{
						throw new Exception($polaczenie->error);
					}
					$sql4 = "SELECT * FROM uzytkownicy WHERE id = $id";
					if($rezultat = $polaczenie -> query($sql4))
					{
						$wiersz4 = $rezultat ->fetch_assoc();
						$skarbonka = $wiersz4['skarbonka'];
						$cel_oszczednosci = $wiersz4['cel_oszczednosci'];
						$potrzebna_ilosc = $wiersz4['potrzebna_ilosc'];
						$_SESSION['skarbonka'] = $skarbonka;
						$_SESSION['cel_oszczednosci'] = $cel_oszczednosci;
						$_SESSION['potrzebna_ilosc'] = $potrzebna_ilosc;
					}
					else 
					{
						throw new Exception($polaczenie->error);
					}
					$polaczenie->close();
				}
			  }
			  catch (Exception $e)
			  {
					echo $e;
			  }
			
	?>
	<div id="dashboard">
		<div class="kafel">
		<?php
			echo "Obecny stan portfela"."</br></br>";
			echo $stan_konta;
		?>
		</div>
		<div class="kafel">
		Ostatnia transakcja: </br></br>
		<?php
			if($ile_transakcji>0)
		  {
				echo $kategoria."</br>".$data."</br>".$cena;
			}
			else 
		  {				
				echo "Brak danych";
			}
		?>
		</div>
		<div class="kafel">
		Ilość transakcji:
		<?php
		if ($ile_transakcji>0) echo "</br></br>".$ile_transakcji;
		else echo "Brak transakcji";
		?>
		</div>
		<div class="kafel">
		Łączny majątek:
		</div>
		<div style="clear:both"></div>
		<div class="kafel_duzy">
		</br>Skarbonka </br></br>
		<?php
		//jesli jeszcze nic nie było robione ze skarbonką
			if ($cel_oszczednosci == "brak")
			{
				echo "Na ten moment brak celów";
			}
			//jeśli jest dodany już cel oszczędzania
			else if($cel_oszczednosci != "brak") 
		  {
				echo "Cel zbieraniny: ".$cel_oszczednosci."</br></br>";
				echo "Potrzebujesz: "."</br>";
				echo "Masz już: 0zł"."</br></br>";
				echo "Łącznie: 0%"."</br></br></br>";
			}
			//jeśli jest dodany cel i dodane juz pierwsze wpłaty
			else if((isset($_SESSION['cel']))&&($_SESSION['oszczednosci'] == true))
			{
				$_SESSION['stan_skarbonki'] =$_SESSION['stan_skarbonki'] + $_SESSION['kwota_przeznaczona'];
				$stan_skarbonki = $_SESSION['stan_skarbonki'] ;
				$procent_celu = ($_SESSION['stan_skarbonki']/$_SESSION['potrzebna_ilosc'])*100;
				echo "Łącznie: ".$stan_skarbonki."</br>";
				echo "Masz już: ".$procent_celu."%</br></br>";
				echo "Cel zbieraniny: ".$_SESSION['cel_oszczednosci']."</br></br>";
				$_SESSION['kwota_przeznaczona'] = 0;
				$pozostalo = $_SESSION['potrzebna_ilosc'] - $stan_skarbonki;
				echo "Pozostało do uzbierania: ".$pozostalo;
			}
			
		?>
		</div>
	</div>
	<div id="footer">Wszelkie prawa zastrzeżone</div>
</div>
</body>

</html>